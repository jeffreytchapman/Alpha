<html>
  <head>
    <title>India52</title>
  </head>
  <body>
  <!--India added save position by minutes button, created positionvariable-->
  <script src="https://www.puck-js.com/puck.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r99/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
  
  <button id="btnConnect" onclick=connectclick()>Connect</button>
  <button id="btnDisconnect" disabled="True" onclick=disconnectclick()>Disconnect</button>
  <button id="btnSavepositionbyminutes" disabled="True" onclick=savepositionbyminutesclick()>Save</button>
  <label for="anglechange">Position duration:</label>
  <input type="text" id="positionduration" name="positionduration" maxlength="7" size="7" readonly>
  <label for="anglechange">Angle change:</label>
  <input type="text" id="anglechange" name="anglechange" maxlength="3" size="3" readonly>
  <label for="batterylevel">Battery Level:</label>
  <input type="text" id="batterylevel" name="batterylevel" maxlength="3" size="3" readonly><br>
  <div>
    <canvas id="chartpositionpastminute" style="width:100%;max-width:1200px"></canvas>
  </div>
  
  <script type="text/javascript">

    //Variables
    var accel = new THREE.Vector3( 0, 0, 1);
    var acceltimer;
    var flashtimer;
    var batterychecktimer;
    var anglechange = "0";
    const date = new Date();
    var lastsignificantpositionchangetime= date.getTime();
    function positionvariable(x, y, z, time) {
      this.x = x;
      this.y = y;
      this.z = z;
      this.time = time;
    }
    const previousposition = new positionvariable(0, 0, 8000, date.getTime());
    //const previousposition = {x:"0", y:"0", z:"8000", time:date.getTime()};
    const currentposition = new positionvariable(0, 0, 0, 0);
    //const currentposition = {x:"0", y:"0", z:"0", time:"0"};
    const position = new positionvariable(0, 0, 0, 0);
    //const position = {x:"0", y:"0", z:"0", time:"0"};
    const positionbyseconds = [];
    const positionpastminutetimevalues = [];
    const positionpastminutexvalues = [];
    const positionpastminuteyvalues = [];
    const positionpastminutezvalues = [];
    for (let i = 0; i < 93; i++) {
      positionbyseconds[i]={x:0, y:0, z:8000, time:date.getTime()};
      console.log("positionbyseconds[i].x=" + positionbyseconds[i].x)
      positionpastminutexvalues[i]=0;
      positionpastminuteyvalues[i]=0;
      positionpastminutezvalues[i]=0;
      positionpastminutetimevalues[i]=(date.getTime()-650*(92-i));
    }
    

    
    
    const positionbyminutes = [];
    positionbyminutes[0]={x:0, y:0, z:8000, time:date.getTime()};
    
    // When we click the connect button...
    function connectclick() {
      document.getElementById("btnConnect").disabled = true;
      document.getElementById("btnDisconnect").disabled = false;
      Puck.write('Puck.accelOn(1.6);\n');
      acceltimer = setInterval(accelcollect,650);
      flashtimer = setInterval(flasher, 650);
      batterycheck();
      batterychecktimer= setInterval(batterycheck, 1000*60*10);
      //Set times
      Puck.setTime();
      const connectclickdate = new Date();
      previousposition.time=connectclickdate.getTime();
    }
    
    // When we click the savepositionbymimutesbutton button...
    function savepositionbyminutesclick() {
      //convert data to csv
      let csvContent = "data:text/csv;charset=utf-8,";
      positionbyminutes.forEach(function(rowArray) {
        //let row = rowArray.prototype.join(",");
        //csvContent += row + "\r\n";
        console.log(rowArray);
        console.log(positionbyminutes.length);
      });
      //console.log(csvContent);
    }
    
    function accelcollect() {
      Puck.eval("Puck.accel()",function(x) {
        const accelcollectdate = new Date();
        //Get accel data
        accel.x=x.acc.x;
        currentposition.x=accel.x;
        accel.y=x.acc.y;
        currentposition.y=accel.y;
        accel.z=x.acc.z;
        currentposition.z=accel.z;
        currentposition.time=accelcollectdate.getTime();
        //Render Vector3
        render();
        
        //update positionbyseconds using an intermediary
        const positiontoadd = new positionvariable();
        positiontoadd=currentposition;
        positionbyseconds.pop;
        positionbyseconds.unshift=(positiontoadd);
        console.log("positionbyseconds[0].x=" + positionbyseconds[0].x);   
        console.log("positionbyseconds[1].x=" + positionbyseconds[1].x); 
        
        //Update past minute chart, most recent position at end of array
        positionpastminutexvalues.push(currentposition.x);
        positionpastminutexvalues.shift();
        positionpastminuteyvalues.push(currentposition.y);
        positionpastminuteyvalues.shift();
        positionpastminutezvalues.push(currentposition.z);
        positionpastminutezvalues.shift();
        positionpastminutetimevalues.push(currentposition.time);
        positionpastminutetimevalues.shift();
        chartpositionpastminute.update("none");
        
        //Get angle change
        anglechange=57.2958*Math.acos((previousposition.x * currentposition.x + previousposition.y * currentposition.y + previousposition.z * currentposition.z) / (Math.sqrt(Math.pow(previousposition.x,2) + Math.pow(previousposition.y,2) + Math.pow(previousposition.z,2)) * Math.sqrt(Math.pow(currentposition.x,2) + Math.pow(currentposition.y,2) + Math.pow(currentposition.z,2))));
        document.getElementById("anglechange").value=Math.round(anglechange);
        //If angle change is significant reset previous position and time
        if (anglechange > 20) {
          previousposition.x=currentposition.x;
          previousposition.y=currentposition.y;
          previousposition.z=currentposition.z;
          previousposition.time=currentposition.time;
          lastsignificantpositionchangetime=currentposition.time
        }
        document.getElementById("positionduration").value=Math.trunc((currentposition.time-lastsignificantpositionchangetime)/(1000*60))+" min";
        
        updateminutedata(currentposition);
      })
      //Puck.write('Puck.accel();\n');
    }
    
    function updateminutedata(inputposition) {
      console.log(Math.trunc((inputposition.time-positionbyminutes[(positionbyminutes.length-1)].time)/1000));    
      if (inputposition.time-positionbyminutes[(positionbyminutes.length-1)].time>=60000) {
        let averagex=0;
        let averagey=0;
        let averagez=0;
        let timetoadd=0
        //let timetoadd=position.time
        //var timetoadd=position.time;
        //const timetoadd=position.time;
        for (let i = 0; i < 93; i++) {
          console.log("positionbyseconds[i].x=" + positionbyseconds[i].x)
          averagex=averagex + positionbyseconds[i].x;
          averagey=averagey + positionbyseconds[i].y;
          averagez=averagez + positionbyseconds[i].z;
        }
        //console.log("prechange inputposition.x=" + inputposition.x)
        //inputposition.x=Math.trunc(averagex/93);
        console.log("postchange inputposition.x=" + inputposition.x)
        //inputposition.y=Math.trunc(averagey/93);
        //inputposition.z=Math.trunc(averagez/93);
        const updateminutedatadate = new Date();
        timetoadd=updateminutedatadate.getTime();
        console.log("positionbyminutes.length pre push=" + positionbyminutes.length)
        
        //positionbyminutes[(positionbyminutes.length-1)].x=(averagex/93);
        //positionbyminutes[(positionbyminutes.length-1)].y=(averagey/93);
        //positionbyminutes[(positionbyminutes.length-1)].z=(averagez/93);
        //positionbyminutes[(positionbyminutes.length-1)].time=timetoadd;
        positionbyminutes.push((averagex/93), (averagey/93), (averagez/93), timetoadd);
        console.log("positionbyminutes.length post push=" + positionbyminutes.length)
        //positionbyminutes[0].y=averagey;
        //positionbyminutes[0].z=averagez;
        //positionbyminutes[0].time=timetoadd;
        if (document.getElementById("btnSavepositionbyminutes").disabled = true) {
          document.getElementById("btnSavepositionbyminutes").disabled = false;
        }
        //console.log("position to be added" + inputposition)
        console.log("after 60 sec update positionbyminutes[last].time="+positionbyminutes[(positionbyminutes.length-1)].time);
        console.log("after 60 sec update positionbyminutes[last].x="+positionbyminutes[(positionbyminutes.length-1)].x);
        console.log("after 60 sec update positionbyminutes[last].y="+positionbyminutes[(positionbyminutes.length-1)].y);
        console.log("after 60 sec update positionbyminutes[last].z="+positionbyminutes[(positionbyminutes.length-1)].z);
        
      }
    }
    
    
    function flasher() {
      Puck.write('digitalPulse(LED2, 1, 200);\n');
    }
    
    async function batterycheck() {
     let myPromise = new Promise(function(myResolve, myReject) {
       myResolve(Puck.eval("E.getBattery()"));
     });
     document.getElementById("batterylevel").value = await myPromise;
   }
    
    function disconnectclick() {
      Puck.write('Puck.accelOff();\n');
      clearInterval(flashtimer);
      clearInterval(acceltimer);
      document.getElementById("btnConnect").disabled = false;
      document.getElementById("btnDisconnect").disabled = true;
      Puck.write('reset();\n');
      //store
      window.localStorage.removeItem("storagepositionbyminutes");
      window.localStorage.setItem("storagepositionbyminutes", JSON.stringify(positionbyminutes));
    }

    // WebGL boilerplate
    var scene, camera, renderer, cube;
    var WIDTH  = window.innerWidth*0.4;
    var HEIGHT = window.innerHeight*0.4;
    function init() {
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(70, WIDTH / HEIGHT, 1, 40);
      camera.position.set(0, -4, 8);
      camera.lookAt(scene.position);
      cube = new THREE.Mesh(new THREE.CubeGeometry(4, 2, 1), new THREE.MeshNormalMaterial());
      scene.add(cube);
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(WIDTH, HEIGHT);
      document.body.appendChild(renderer.domElement);
    }
    
    function render() {
      cube.lookAt(accel);
      renderer.render(scene, camera);
    }
    init();
    render();
    
    //Charting
    var pastminutectx = document.getElementById("chartpositionpastminute");
    var chartpositionpastminute = new Chart(pastminutectx, {
      type: "line",
      data: {
        labels: positionpastminutetimevalues,
        datasets: [{
          label: "X",
          fill: false,
          lineTension: 0,
          backgroundColor: "rgba(0,0,255,1.0)",
          borderColor: "rgba(0,0,255,0.1)",
          data: positionpastminutexvalues,
        }, {
          label: "Y",
          fill: false,
          lineTension: 0,
          backgroundColor: "rgba(0,255,0,1.0)",
          borderColor: "rgba(0,255,0,0.1)",
          data: positionpastminuteyvalues,
        }, {
          label: "Z",
          fill: false,
          lineTension: 0,
          backgroundColor: "rgba(255,0,0,1.0)",
          borderColor: "rgba(255,0,0,0.1)",
          data: positionpastminutezvalues,
        }]
      },
      options: {
        title: "Position past minute",
        legend: {display: true},
        scales: {
          yAxes: [{ticks: {min: -10000, max: 10000},
                   position: "right"}],
          xAxes: [{ticks: {min: 0, max: 60, display: false},
                   position: "center"}],
        }
      }
    });
    
 </script>
 </body>
</html>
